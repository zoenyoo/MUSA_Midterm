---
title: "MUSA508_midterm"
author: "Jasmine Siyu Wu"
date: "10/18/2021"
output: 
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
---
<br />

```{r knitr.setup, include=TRUE, cache = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width = 10, fig.height = 5)
```
<br />

## 1. Introduction
[placeholder of paragraphs]

<br />
<br />


## 2. Setting Up Environment and Styling
This section sets up the environment including libraries, styling options, quintile break functions, and color palettes.

**Loading Libraries**
```{r setup, include=TRUE, cache = FALSE, message = FALSE}
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance)
library(osmdata)
library(knitr)
library(tidycensus)
library(scales)


options(scipen=999) 
options(tigris_class = "sf")
options(tigris_use_cache = TRUE)

root.dir = "C:/Users/11486/Box/2021Fall/CPLN592/Assignments/Midterm/MUSA508_midterm"
```

**Loading Styling Options**
```{r load_styling, include=TRUE, cache = FALSE, message = FALSE, warning = FALSE}
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.text.x = element_text(size = 14))
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 16,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}
```

**Loading Quantile Break Functions**
```{r qBr, include=TRUE, cache = FALSE, message = FALSE, warning = FALSE}
qBr <- function(df, variable, rnd) {
 if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                 c(.01,.2,.4,.6,.8), na.rm=T))
 } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                 c(.01,.2,.4,.6,.8), na.rm=T), digits = 3))
 }
}


q5 <- function(variable) {as.factor(ntile(variable, 5))}
```

**Loading Hexadecimal Color Palette**
```{r palette5, include=TRUE, cache = FALSE, message = FALSE, warning = FALSE}
palette5 <- c("#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c")
```

<br />
<br />

## 3. Data Wrangling
[placeholder of paragraphs]

<br />

### 3.1. Loading Data

loading features
```{r read_data, cache = TRUE, message = FALSE, warning = FALSE}
# read in boulder training data
boulder.sf <- 
  st_read("studentData.geojson", crs="ESRI:102254") %>%
  st_transform('ESRI:102254') %>%  # "NAD_1983_HARN_StatePlane_Colorado_North_FIPS_0501"
  st_make_valid() %>% 
  mutate(Age = 2021 - builtYear)

boulder.sf[2638,]$price <- 315000 #mistake input as 31500000, checked on zillow



# read in commissioner districts
# data source: boulder county open data portal
coms_dists.sf <-
  st_read("https://opendata.arcgis.com/datasets/1fb6698cad044e3fb0471d1d464049ad_0.geojson") %>%
  st_transform(st_crs(boulder.sf))


# read in boulder county playgrounds (point)
# data source: boulder county open data portal
playgrounds.sf <- 
  st_read("https://opendata.arcgis.com/datasets/b89ea27bc3cd492682503f03df1a9fb9_0.geojson") %>%
  st_as_sf(coords=playgrounds.sf$geometry, crs = 4326) %>% 
  st_transform(st_crs(boulder.sf)) 


# read in schools in boulder county from open street map
# data source: open street map
schools <- osmdata_sf(getbb("Boulder County", base_url="https://nominatim.openstreetmap.org") %>% 
                             opq() %>% 
                             add_osm_feature("amenity", "school"))$osm_points

schools.sf <- st_as_sf(schools, coords=schools$geometry, crs = 4326) %>% 
  st_geometry(schools.sf$geometry) %>%
  st_transform(st_crs(boulder.sf))  %>%
  st_sf() %>%
  cbind(., schools$name) %>%
  rename(NAME = schools.name)


# read in parks from open street map
# data source: open street map
parks <- osmdata_sf(getbb("Boulder County", base_url="https://nominatim.openstreetmap.org") %>% opq() %>%
                      add_osm_feature(key = 'leisure', value = "park"))

parks.sf <- st_geometry(parks$osm_polygons) %>%
  st_transform(st_crs(boulder.sf)) %>%
  st_sf() %>%
  cbind(., parks$osm_polygons$name) %>%
  rename(NAME = parks.osm_polygons.name)


# read in pollution score




# read in transit stops
# data source: open street map
bus_stops <- osmdata_sf(getbb("Boulder County", base_url="https://nominatim.openstreetmap.org") %>% 
                             opq() %>% 
                             add_osm_feature("highway", "bus_stop"))$osm_points

bus_stops.sf <- st_as_sf(bus_stops, coords=bus_stops$geometry, crs = 4326) %>% 
  st_geometry(bus_stops.sf$geometry) %>%
  st_transform(st_crs(boulder.sf)) %>%
  st_sf() %>%
  cbind(., bus_stops$name) %>%
  rename(NAME = bus_stops.name)


# read in highway ramps



# read in grass land from open street map
# data source: open street map
grass <- osmdata_sf(getbb("Boulder County", base_url="https://nominatim.openstreetmap.org") %>% opq() %>%
                      add_osm_feature(key = 'landuse', value = "grass"))

grass.sf <- st_geometry(grass$osm_polygons) %>%
  st_transform(st_crs(boulder.sf)) %>%
  st_sf() %>%
  cbind(., grass$osm_polygons$name) %>%
  rename(NAME = grass.osm_polygons.name)



# read in lakes and reservoirs data
# data source: boulder county open data portal
lakes.sf <-
  st_read("https://opendata.arcgis.com/datasets/e0759cd6dc8f4990a04b77a29c988b55_0.geojson") %>%
  st_transform(st_crs(boulder.sf))


# read in trail routes
# data source: boulder county open data portal
trails.sf <-
  st_read("https://opendata.arcgis.com/datasets/3ed1045255c34eada007840a5dd84de9_0.geojson") %>%
  st_transform(st_crs(boulder.sf))


# read in trailheads
# data source: boulder county open data portal
trailheads.sf <-
  st_read("https://opendata.arcgis.com/datasets/3a950053bbef46c6a3c2abe3aceee3de_0.geojson") %>%
  st_transform(st_crs(boulder.sf))


# read in parcels
# data source: boulder county open data portal
parcels.sf <-
  st_read("https://opendata.arcgis.com/datasets/89ae49d4ddf246388ee5f5e952aa84db_0.geojson") %>%
  st_transform(st_crs(boulder.sf))


# read in mobile homes
# data source: boulder county open data portal
trailheads.sf <-
  st_read("https://opendata.arcgis.com/datasets/8d53540bcc264bc3b13a500ab274bfa6_0.geojson") %>%
  st_transform(st_crs(boulder.sf))

```
<br />

Loading boundaries and demographic data

```{r read_acs_data, cache = TRUE, message = FALSE, warning = FALSE}
acs_variable_list.2019 <- load_variables(2019, #year
                                         "acs5", #five year ACS estimates
                                         cache = TRUE)



# read in boulder county boundary
# data source: boulder county open data portal
county_boundary <-
  st_read("https://opendata.arcgis.com/datasets/964b8f3b3dbe401bb28d49ac93d29dc4_0.geojson") %>%
  st_transform(st_crs(boulder.sf))

# read in places (cities)
# data source: ACS 2015-19 5yr
places <- get_acs(geography = "place", 
                    year = 2019,
                    state = 08,
                    variables = (TotalPop = 'B01001_001E'),
                    survey = "acs5",
                    output = "wide",
                    geometry = TRUE) %>%
  st_transform(st_crs(boulder.sf))

# filter out cities in boulder county
bc.places <-  
  st_centroid(places)[county_boundary,] %>%
  st_drop_geometry() %>%
  left_join(places) %>%
  st_sf() 

# read in ACS 5yr 2015-19 estimates
tractsBC19 <- 
  get_acs(geography = "tract", variables = c("B01001_001","B02001_002","B15001_050",
                                             "B15001_009","B19013_001","B25058_001",
                                             "B06012_002"), 
          year=2019, state=08, county=013, geometry=T,output="wide") %>%
  st_transform(st_crs(boulder.sf)) %>%
  rename(TotalPop = B01001_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop,0), # avoid of NAs
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop),0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2019") %>%
  dplyr::select(-Whites, -FemaleBachelors, -MaleBachelors, -TotalPoverty) 



# visualize raw data
ggplot() +
    geom_sf(data=county_boundary, show.legend = NA, color='grey',alpha=0.5, lwd=0.3)+
    geom_sf(data=bc.places, show.legend = NA, color='grey', lwd=0.1)+
    geom_sf(data = boulder.sf, aes(colour = q5(price)), 
            show.legend = "point", size = 1) + 
    scale_fill_manual(values = palette5,
                      labels = qBr(boulder.sf, "price"),
                      name = "House Price\n(Quintile Breaks)")
    #geom_sf(data=playgrounds.sf, color="black", alpha=0.7, shape=18, size=1)+
    #geom_sf(data=schools, color="black", shape=15, alpha=0.7, size=1) 
    #+    coord_sf(datum=st_crs(boulder.sf))

```


### 3.2. Data Cleaning





<br />

### 3.3. Feature Engineering



<br />

### 3.4. Exploratory Data Analysis




<br />
<br />


## 4. Correlation Analysis
[placeholder of paragraphs]

<br />

### 4.1. Analyzing Associations



<br />

### 4.2. Correlation Matrix



<br />
<br />


## 5. Regression Analysis
[placeholder of paragraphs]


<br />

### 5.1. Multivariate Regression 1



<br />

### 5.2. Multivariate Regression 2



<br />

### 5.3. Prediction Examples




<br />
<br />


## 6. Neighborhood Model
[placeholder of paragraphs]





<br />
<br />

## 7. Conclusion
[placeholder of paragraphs]







